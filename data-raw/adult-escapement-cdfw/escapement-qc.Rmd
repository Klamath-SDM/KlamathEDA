---
title: "Salmon River - Klamath basin escapement data qc"
author: "Badhia Yunes Katz"
date: "09/24/2024"
output: rmarkdown::github_document
---
```{r,include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library (RColorBrewer)
library(readxl)
library(janitor)
```
# Klamath River basin - Salmon River Carcass Mark Recapture Survey Data  

The goal of this markdown is to:

   (1) identify what types of data are included, 
   (2) data quality, 
   (3) resolve quality issues where we can, 
   (4) make data more usable

## Description of Monitoring Data

Upper Salmon River Carcass Mark Recapture Spawning Grounds Surveys. Located on the Upper Salmon River (above Nordheimer Campground), including Upper Mainstem, and North and South Forks of the Salmon River and tributaries.

   
**Timeframe:** 2011-10-14 to 2022-12-09

**Completeness of Record throughout timeframe:** data collected only during months of Oct-December

**Sampling Location:** Upper Salmon River Carcass Mark Recapture Spawning Grounds Surveys. Located on the Upper Salmon River (above Nordheimer Campground), including Upper Mainstem, and North and South Forks of the Salmon River and tributaries.

**Data Contact:** [Dan Troxel](mailto::dan.troxel@wildlife.ca.gov)

Any additional info?

## Access Data

Read in data shared by Morgan Knechtle, but publicly available at [California Open Data Portal](https://data.ca.gov/dataset/fall-chinook-escapement-klamath-basin-watershed) 

## Data transformations

```{r,include=FALSE}
# For different excel sheets for each year read in and combine years here
salmon_river_recapture_22 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 1) |> 
  clean_names() |> 
  mutate(path = as.numeric(path),
         tag_app = as.numeric(tag_app),
         recap = as.numeric(recap),
         clips = as.character(clips),
         headtag = as.character(headtag)) |> 
  glimpse()

salmon_river_recapture_21 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 2) |> 
  clean_names() |> 
  mutate(path = as.numeric(path),
         tag_app = as.numeric(tag_app)) |> 
  glimpse()

salmon_river_recapture_20 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 3) |> 
  clean_names() |> 
  mutate(path = as.numeric(path),
         tag_app = as.numeric(tag_app),
         recap = as.numeric(recap),
         clips = as.character(clips),
         headtag = as.character(headtag)) |>
  glimpse()

salmon_river_recapture_19 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 4) |> 
  clean_names() |> 
  mutate(path = as.numeric(path),
         tag_app = as.numeric(tag_app),
         recap = as.numeric(recap),
         clips = as.character(clips),
         headtag = as.character(headtag)) |>
  glimpse()

salmon_river_recapture_18 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 5) |> 
  clean_names() |> 
  mutate(path = as.numeric(path), # 4 fields with text indicating "no survey", setting those as NA
         tag_app = as.numeric(tag_app),
         recap = as.numeric(recap), # there is a slash on 2018-11-20 (6106/7725), turning into NA
         clips = as.character(clips),
         headtag = as.character(headtag)) |>
  glimpse()

salmon_river_recapture_17 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 2, sheet = 6) |> 
  clean_names() |> 
  mutate(tag_app = as.numeric(tag_app),
         clips = as.character(clip),
         headtag = as.character(headtag)) |>
  select(-c(clip)) |> 
  glimpse()

salmon_river_recapture_16 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 7) |> 
  clean_names() |> 
  mutate(clips = as.character(clip),
         headtag = as.character(headtag)) |>
  rename(path = path_number) |> 
  select(- clip) |> 
  glimpse()

salmon_river_recapture_15 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 8) |> 
  clean_names() |> 
  rename(path = path_number,
         clips = clip) |> 
  mutate(headtag = as.character(head_tag_number)) |>
  select(-c(head_tag_number)) |> 
  glimpse()

salmon_river_recapture_14 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 9) |> # check headtag vs head_tag_number
  clean_names() |> 
  mutate(headtag = as.character(head_tag_number),
         clips = as.character(clip),
         fl = as.numeric(fl)) |> 
  rename(path = path_number) |> 
  select(-c(head_tag_number, clip)) |> # removing since it is the same
  glimpse()

salmon_river_recapture_13 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 10) |> 
  clean_names() |> 
  mutate(headtag = as.character(head_tag_number), 
         clips = as.character(clip)) |>
  rename(path = path_number) |> 
  select(-c(head_tag_number, clip)) |>
  glimpse()

salmon_river_recapture_12 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 11) |> 
  clean_names() |> 
  mutate(fl = as.numeric(fl),
         headtag = as.character(head_tag_number)) |> 
  rename(path = path_number,
         tag_app = j_tag_applied,
         recap = j_tag_recap,
         clips = ad_clip_y_n,
         rel_chop = release_chop) |> 
  select(-c(head_tag_number)) |> 
  glimpse()

salmon_river_recapture_11 <- read_xlsx("data-raw/adult-escapement-cdfw/Salmon River Carcass Mark Recapture 2011-2022.xlsx", skip = 1, sheet = 12) |> # missing  rel_chop field
  clean_names() |> 
  mutate(headtag = as.character(headtag)) |> 
  rename(path = path_number,
         clips = clip) |> 
  glimpse()
```

```{r}
# combining years
recapture <- bind_rows(salmon_river_recapture_11, salmon_river_recapture_12, salmon_river_recapture_13, salmon_river_recapture_14, salmon_river_recapture_15, salmon_river_recapture_16, salmon_river_recapture_17, salmon_river_recapture_18, salmon_river_recapture_19, salmon_river_recapture_20, salmon_river_recapture_21, salmon_river_recapture_22)
```


## Explore Numeric Variables: {.tabset}

```{r}
# Filter clean data to show only numeric variables 
recapture |> 
  select_if(is.numeric) |> 
  colnames()
```

Temporal coverage

```{r}
range(recapture$date)
```

### Variable: `path`

1-Fresh, 2-Not Fresh, 3-Recapture, 4-Unretrievable

**Plotting path over Period of Record**

```{r, warning=FALSE}
# Make whatever plot is appropriate 
ggplot(recapture, aes(date, path)) +
  geom_point()

ggplot(recapture, aes(x = path)) +
  geom_bar() +
  labs(title = "Count of Observations per Path", x = "Path", y = "Count") +
  theme_minimal()

ggplot(recapture, aes(x = path)) +
  geom_bar() +
  facet_wrap(~year(date)) +
  labs(title = "Count of Observations per Path", x = "Path", y = "Count") +
  theme_minimal()

ggplot(recapture, aes(x = month(date, label = TRUE), fill = path)) + 
  geom_bar() +
  facet_wrap(~year(date)) +
  labs(x = "Month", y = "Count", title = "Distribution of Paths by Month Across Years") +
  theme_minimal()

# maybe 2+ plots are appropriate
```

**Numeric Summary of path over Period of Record**

```{r}
# Table with summary statistics
summary(recapture$path)
```

**NA and Unknown Values**

There are `r is.na(recapture$path) |> sum()` NA values


### Variable: `fl`

**Plotting path over Period of Record**
```{r}
range(recapture$fl, na.rm = TRUE)

ggplot(recapture, aes(date, fl)) + #noticing one outlier
  geom_point()

# removing outlier and plotting again

recapture |> 
  filter(fl <600) |> 
  ggplot(aes(date, fl)) + 
  geom_point() +
  labs(x = "Date", y = "Folk Length", title = "Folk length vs Date") +
  theme_minimal()
```
```{r}
# remonving fl outlier
recapture <- recapture |> 
  mutate(fl = ifelse(fl > 600, NA, fl)) 

range(recapture$fl, na.rm = TRUE)

```

```{r,warning=FALSE}
recapture |> 
ggplot(aes(x = fl)) + 
  geom_histogram(breaks=seq(0, 200, by=2)) + 
  scale_x_continuous(breaks=seq(0, 200, by=25)) +
  theme_minimal() +
  labs(title = "Fork length distribution") + 
  theme_minimal() 
  
recapture |> 
  mutate(sex = case_when(sex %in% c("F", "f") ~ "female",
                         sex %in% c("M", "m") ~ "male",
                         sex %in% c(46, "N", "U", "Y",NA) ~ "unknown")) |> 
  ggplot(aes(x = sex, y = fl)) +
  geom_boxplot() +
  # facet_wrap(~disposition) +
  theme_minimal() + 
  labs(y = "fork length (mm)", x = "sex")

# recapture |> 
#   ggplot(aes(x = sex, y = fl)) + # sex seems to have more than M and F. Will check this below
#   geom_bar()
```
**Numeric Summary of path over Period of Record**

```{r}
# Table with summary statistics
summary(recapture$fl)
```

**NA and Unknown Values**

There are `r is.na(recapture$fl) |> sum()` NA values


### Variable: `tag_app`

"unique tag # attached to carcass upon first encounter"


**Plotting path over Period of Record**

```{r, warning = FALSE}
recapture |> 
  ggplot(aes(date, tag_app)) +
  geom_point()

#TODO - think of another plot
```

**NA and Unknown Values**

There are `r is.na(recapture$tag_app) |> sum()` NA values

### Variable: `recap`

"unique tag # of tag on carcass during recapture"

**Plotting path over Period of Record**

```{r, warning = FALSE}
recapture |> 
  ggplot(aes(date, recap)) +
  geom_point()

#TODO - think of another plot
```

**NA and Unknown Values**

There are `r is.na(recapture$recap) |> sum()` NA values


## Explore Categorical variables: {.tabset}

General notes: If there is an opportunity to turn yes no into boolean do so, but not if you loose value 

```{r}
# Filter clean data to show only categorical variables
recapture |>  select_if(is.character) |>  colnames()
```


### Variable: `sex`
```{r}
table(recapture$sex) # f - female, m - male, not sure what others are
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
recapture <- recapture |> #check if this assumption makes sense
  mutate(sex = case_when(
    sex %in% c("F", "f") ~ "female",
    sex %in% c("M", "m") ~ "male",
    sex %in% c(46, "N", "U", "Y") ~ "unknown"
  )) 
  # Create the plot
  ggplot(recapture, aes(x = month(date, label = TRUE), fill = sex)) +
  geom_bar() +
  facet_wrap(~year(date)) +
  theme_minimal() + 
  labs(y = "Count", x = "Month", title = "Total Counts of Each Sex Type by Month") +
  scale_fill_manual(values = c("female" = "pink", "male" = "lightblue", "unknown" = "gray")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

There are `r is.na(recapture$sex) |> sum()` NA values

### Variable: `spawn`
```{r}
table(recapture$spawn) # will assume T - Blank #TODO check if this is ok
#Y-yes, N-no, or blank
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
recapture <- recapture |> 
    mutate(spawn = case_when(
    spawn %in% c("Y", "y") ~ "yes",
    spawn %in% c("N", "n") ~ "no",
    spawn == "T" ~ "blank" # TODO, assuming T - blank, check if this is true
  ))

recapture |> 
  ggplot(aes(x = month(date), fill = spawn)) +
  facet_wrap(~year(date), scales = "free") +
  geom_bar(position = "dodge", na.rm = FALSE) +
  scale_x_continuous(breaks = 1:12, labels = month.abb) +  
  labs(x = "Month", y = "Count", title = "Side-by-Side Counts by Spawn Type Across Months and Years") +
  theme_minimal()
```

```{r,waraning=FALSE}
recapture |> 
  ggplot(aes(spawn, fl)) +
  geom_boxplot()
```


**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

There are `r is.na(recapture$spawn) |> sum()` NA values

### Variable: `clips`

description of hatchery marks - e.g. fin clip, jaw clip

```{r}
table(recapture$clips) #TODO figure out what this means 
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

There are `r is.na(recapture$clips) |> sum()` NA values


### Variable: `headtag`
```{r}
table(recapture$headtag) # there are only two values, not worth qc'ing
```


**NA and Unknown Values**

There are `r is.na(recapture$headtag) |> sum()` NA values


### Variable: `rel_chop`

release or re-released tagged fish, or chopped untagged fish

```{r}
table(recapture$rel_chop)
```

Fix inconsistencies with spelling, capitalization, and abbreviations. 

```{r}
# Fix any inconsistencies with categorical variables
recapture <- recapture |> 
    mutate(rel_chop = case_when(
    rel_chop %in% c("c", "C") ~ "chop",
    rel_chop %in% c("r", "R") ~ "re-released",
    rel_chop == "RC" ~ "unknown" 
  )) 
```

**Create lookup rda for [variable] encoding:** 
```{r}
# Create named lookup vector
# Name rda [watershed]_[data type]_[variable_name].rda
# save rda to data/ 
```

**NA and Unknown Values**

There are `r is.na(recapture$rel_chop) |> sum()` NA values


## Summary of identified issues

* List things that are funky but that we don't feel like should be changed without more investigation

## Save cleaned data back to /data folder 

```{r}
# Write to /data folder
# Name file [watershed]_[data type].csv
```