---
title: "Location Exploration"
author: "Maddee Wiggins (FlowWest)"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(leaflet)
library(sf)
library(tidyverse)
```

### **Objectives**

1.  download NHD layers for Klamath Basin
    -   NHDplus geodatabase downloaded from: <https://www.sciencebase.gov/catalog/item/5d30c29ae4b01d82ce84aa5e>
    -   NHDplus user guide: <https://pubs.usgs.gov/of/2019/1096/ofr20191096.pdf>
2.  explore NHD layer and HUC options
3.  assign river miles based on mainstem NHD

```{r echo=TRUE, message=FALSE, warning=FALSE}
hucs <- read_sf(here::here('data-raw', 'shapefiles', 'WBDHU8_Klamath_Rogue.shp')) |> 
  filter(!grepl('17', huc8)) 

huc6 <- "180102"

ggplot() +
  geom_sf(data = hucs) +
  theme_minimal()

```

```{r echo=TRUE, message=FALSE, warning=FALSE}
layers <- st_layers('data-raw/shapefiles/NHDPLUS_H_1801_HU4_GDB.gdb/')

nhd_fcode <- st_read('data-raw/shapefiles/18/NHDPLUS_H_1801_HU4_GDB.gdb/', layer = 'NHDFCode') |> 
  janitor::clean_names() 

nhd_flowline_vaa<- st_read('data-raw/shapefiles/18/NHDPLUS_H_1801_HU4_GDB.gdb/', layer = 'NHDPlusFlowlineVAA') |> 
  janitor::clean_names() 

nhd_flowline_raw <- st_read('data-raw/shapefiles/18/NHDPLUS_H_1801_HU4_GDB.gdb/', layer = 'NHDFlowline') |> 
  janitor::clean_names() 

fcode_descr <- c("Stream/River", "Artificial Path",
                 "Stream/River: Hydrographic Category = Intermittent",
                 "Stream/River: Hydrographic Category = Perennial", "Stream/River: Hydrographic Category = Ephemeral")  

nhd_flowline <- nhd_flowline_raw |> 
  mutate(rc_huc_6 = substr(reach_code, 1, 6),
         rc_huc_8 = substr(reach_code, 1, 8),
         rc_huc_10 = substr(reach_code, 1, 10),
         rc_huc_12 = substr(reach_code, 1, 12)) |> 
  filter(rc_huc_6 == huc6) |> # filter to klamath huc6
  filter(!is.na(gnis_name)) |> # remove NA streams 
  left_join(nhd_fcode) |> 
  filter(description %in% fcode_descr) |> 
  left_join(nhd_flowline_vaa) |> 
  #filter(main_path == 1) |> 
  #filter(in_network == 1) |> 
  glimpse()

ggplot() +
  geom_sf(data = hucs, aes(color = 'darkred')) +
  geom_sf(data = nhd_flowline) +
  theme_minimal() +  
  theme(legend.position = "none")

```

```{r message=FALSE, warning=FALSE}
# filtering to mainstem and tribs of interest 

rivers <- c('Klamath River', 'Trinity River', 'Sprague River',
            'Williamson River', 'Wood River', 'Lost River', 'Shasta River', 
            'Scott River', 'Salmon River', 'Blue Creek', 'Bogus Creek', 'Clear Creek',
            'Indian Creek', 'Link River')

nhd_flowline_filtered <- nhd_flowline |> 
  filter(gnis_name %in% rivers) |> 
  st_transform(crs = "+proj=longlat +datum=WGS84") |> 
  st_zm()

ggplot() +
  geom_sf(data = hucs) +
  geom_sf(data = nhd_flowline_filtered) +
  theme_minimal()

```

```{r}
leaflet(data = nhd_flowline_filtered) |> 
  addTiles() |> 
  addPolylines(popup = ~gnis_name)

```

### Assign River Miles 

```{r}
# start with bogus creek

bogus_crk <- nhd_flowline_filtered |> 
  filter(gnis_name == "Bogus Creek")

bogus_crk_combinded <- bogus_crk |> 
  arrange(desc(hydro_seq)) |> # or reach_code?
  st_combine() |> 
  st_line_merge() |> 
  st_transform(crs = 32610)

river_points <- st_line_sample(bogus_crk_combinded, n = 100)  |> 
  st_cast("POINT")

river_points <- st_sf(geometry = river_points, crs = st_crs(bogus_crk_combinded))

# units are in meters
distances <- sapply(1:(length(river_points$geometry) - 1), function(i) {
  st_distance(river_points$geometry[i], river_points$geometry[i + 1])
}) 
cumulative_distances <- c(0, cumsum(distances)) |> sort(decreasing = TRUE)

river_mile_points <- river_points  |> 
  mutate(river_meter = cumulative_distances,
         river_km = river_meter/1000,
         river_mile = river_meter/1609.34) |> 
   st_transform(crs = "+proj=longlat +datum=WGS84") 

ggplot() +
  geom_sf(data = river_mile_points, aes(size = river_mile), alpha = 0.5) +
  theme_minimal()

  
leaflet() |> 
  addTiles() |> 
  addCircleMarkers(data = river_mile_points,
                   radius = ~river_mile / max(river_mile) * 10,
                   popup = ~as.character(round(river_mile, 2))) 


```

```{r eval=FALSE, include=FALSE}
# Filter for Bogus Creek
bogus_crk <- nhd_flowline_filtered |> 
  filter(gnis_name == "Bogus Creek") |> 
  arrange(desc(hydro_seq)) |>  # Arrange by hydro_seq for logical order
  mutate(segment_id = row_number())

# Transform to UTM for distance calculations
bogus_crk <- st_transform(bogus_crk, crs = 32610)

# Function to calculate river mile points for each segment
calculate_river_miles <- function(segment) {
  
  segment <- segment |> 
    st_cast("LINESTRING")
  
  # Sample points along the segment
  river_points <- st_line_sample(segment, density = units::set_units(1, 1/km)) |> 
    st_cast("POINT")
  
  # Convert to sf object
  river_points <- st_sf(geometry = river_points, crs = st_crs(segment))
  
  # Calculate distances between consecutive points
  distances <- sapply(1:(length(river_points$geometry) - 1), function(i) {
    st_distance(river_points$geometry[i], river_points$geometry[i + 1])
  })
  
  # Calculate cumulative distances
  cumulative_distances <- c(0, cumsum(distances))
  
  # Add attributes to the points
  river_points <- river_points |> 
    mutate(
      river_meter = cumulative_distances,
      river_km = river_meter / 1000,
      river_mile = river_meter / 1609.34
    )
  
  return(river_points)
}

river_mile_points_list <- lapply(1:nrow(bogus_crk), function(i) {
  calculate_river_miles(bogus_crk[i, ])
})

# Combine the results
river_mile_points <- do.call(rbind, river_mile_points_list)

bogus_crk <- st_transform(bogus_crk, st_crs(river_mile_points)) |> 
  st_cast("POINT") |> 
  mutate(vertex_id = row_number()) 

```

```{r}
knitr::knit_exit()
```

cleaning data - merge with NHDFCode - remove NAs from gnis_name - filter by mainpath and innetwork == 1 - filter by fcodes that are not rivers (note: KEEP artificial paths as they are river segments) - add 8,10,12 digit HUCs using script:
mutate(rc_huc_8 = substr(reachcode, 1, 8), rc_huc_10 = substr(reachcode, 1, 10), rc_huc_12 = substr(reachcode, 1, 12))

river miles - make a point layer for river miles (fractions of a river mile) - sf::st_line_sample() makes points along the line, assign some X feet spacing - order segments from downstream to upstream, cumulative length moving down segments, what is the river mile at start? - each trib gets its own sequence of river miles - sf::st_nearest_feature() to find the nearest river mile to each feature (such as RST)

value added attributes \> hydrosequence (hydroseq) - this is flow order, so arranging table by this should be upstream to downstream (or vice versa)

### Downloading NHD using nhdPlusTools

Using `nhdplusTools`. I found this to be much slower. You end up receiving many geodatabases by HUC4s that would need to be merged. The download process takes significantly longer than how it is outlined above. 
```{r eval=FALSE, include=FALSE}
#install.packages('nhdplusTools')
library(nhdplusTools)

download_nhdplushr(here::here('data-raw', 'shapefiles'), c('180102'), download_files = TRUE)

```

```{r eval=FALSE, include=FALSE}
layers <- st_layers('data-raw/shapefiles/18/NHDPLUS_H_1810_HU4_GDB.gdb/')

data <- st_read('data-raw/shapefiles/18/NHD_H_1801_HU4_GDB.gdb/', layer = 'NHDFlowline')

ggplot() +
  geom_sf(data = data) +
  geom_sf(data = hucs, aes(color = 'red')) 

```


```{r}
#hucs
hucs <- sf::read_sf('shiny/data/shapefiles/WBDHU8_Klamath_Rogue_prj.shp') |> 
  sf::st_transform('+proj=longlat +datum=WGS84')
leaflet(data = hucs) |> 
  addTiles() |> 
  addPolygons(popup = ~name)

```
